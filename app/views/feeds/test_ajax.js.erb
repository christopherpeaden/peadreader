var xhr; 
if (window.XMLHttpRequest) 
  xhr = new XMLHttpRequest(); 
else if (window.ActiveXObject) 
  xhr = new ActiveXObject("Msxml2.XMLHTTP");
else 
  throw new Error("Ajax is not supported by your browser");

xhr.onreadystatechange = function () {
  if (xhr.readyState < 4) {
  }
  else if (xhr.readyState === 4) {
    if (xhr.status == 200 && xhr.status < 300) {
      var response = JSON.parse(xhr.responseText);
      for(var x = 0; x < response.length; x++) {
        var li = document.createElement("li");
        var itemTitle = document.createTextNode(response[x]["title"]);
        var channel = document.createTextNode("channel");
        var publishedAt = document.createTextNode(response[x]["published"]);
        var url = document.createTextNode(response[x]["url"]);
        var br = document.createElement('br');
        var br2 = document.createElement('br');

        var btn = document.createElement("a");
        var buttonText = document.createTextNode("More");
        btn.appendChild(buttonText);
        btn.className = "btn";
        btn.href = "/feeds";

        var a = document.createElement("a");
        a.appendChild(channel);
        a.appendChild(itemTitle);
        a.appendChild(btn);
        a.href = response[x]['url'];
        a.appendChild(br2);

        if(response[x]["image_thumbnail_url"]) {
          var thumbnailUrl = document.createElement("img");
          thumbnailUrl.setAttribute('src', response[x]["image_thumbnail_url"]);
          thumbnailUrl.setAttribute('height', '250px');
          thumbnailUrl.setAttribute('width', '400px');
          li.appendChild(thumbnailUrl);
          a.insertBefore(br, a.childNodes[0]);
        }


        li.appendChild(a);
        li.appendChild(publishedAt);
        li.setAttribute('data-published', response[x]["published"]);
        var list = document.getElementsByClassName("list-group")[0];
        list.insertBefore(li, list.children[0]);
      }
    }
  }
}

function sendXhrRequest() {
  var list = document.getElementsByClassName("list-group")[0];
  var latestItem = list.children[0];
  var after = latestItem.getAttribute("data-published");

  xhr.open('GET', 'http://localhost:3000/test_ajax2?after=' + after)
  xhr.send(null);
}

setTimeout(sendXhrRequest, 3000);

